{% if not is_admin %}
  <div class="alert alert-info">⚠️ Sign in as admin to access metrics.</div>

{% else %}
{% if not metrics_available %}
  <div class="alert alert-info">
    No metrics logged yet.
  </div>
{% else %}

  {% if max_psi > 0.2 %}
    <div class="alert alert-warning">
      ⚠️ Data drift detected (max PSI = {{ max_psi }})
    </div>
  {% else %}
    <div class="alert alert-success">
      ✅ No significant drift detected (max PSI = {{ max_psi }})
    </div>
  {% endif %}

  <!-- Metric selection -->
  <div class="mb-3">
    <form method="GET" action="">
      <input type="hidden" name="tab" value="metrics">

      <label for="metric-select" class="form-label">
        Select metric to visualize:
      </label>

      <select
        id="metric-select"
        name="metric"
        class="form-select"
        onchange="this.form.submit()"
      >
        {% for metric in metric_options %}
          <option
            value="{{ metric }}"
            {% if metric == request.args.get('metric', metric_options[0]) %}
              selected
            {% endif %}
          >
            {{ metric }}
          </option>
        {% endfor %}
      </select>
    </form>
  </div>
  
  <!-- Plotly chart -->
  {% if metrics_chart %}
    <div class="d-flex justify-content-center mb-4">
      <div id="metrics-chart-wrapper" style="overflow-x:auto; max-width: 800px; width: 100%;">
        {{ metrics_chart | safe }}
      </div>
  </div>
  {% endif %}

  <hr>
   <!-- Feature-level PSI Table (Collapsible) -->
  <div class="mx-auto mb-4" style="max-width: 800px; text-align: center;">
    <button class="btn btn-outline-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#psiCollapse" aria-expanded="false" aria-controls="psiCollapse">
      View Feature-Level Drift (PSI)
    </button>

    <div class="collapse" id="psiCollapse">
      <div class="card card-body mt-2" style="overflow-x:auto;">
        <table class="table table-striped table-sm text-center">
          <thead>
            <tr>
              <th>Feature</th>
              <th>PSI</th>
            </tr>
          </thead>
          <tbody>
            {% for feature, psi in psi_values.items() %}
            <tr>
              <td>{{ feature }}</td>
              <td>{{ '%.3f'|format(psi) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <hr>
  <h5>Model Performance Over Time</h5>
  <div style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th>Timestamp</th>
          {% for key in metrics_table[0].keys() %}
            {% if key != 'timestamp' %}
              <th>{{ key }}</th>
            {% endif %}
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in metrics_table %}
          <tr>
            <td>{{ row.timestamp if row.timestamp else "N/A" }}</td>
            {% for key, value in row.items() %}
              {% if key != 'timestamp' %}
                <td>{{ value }}</td>
              {% endif %}
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
{% endif %}